# rootkit
## r77-rootkit
* [项目地址](https://github.com/bytecode77/r77-rootkit)
* 系统: win7, win10 (x86和x64)
* 隐藏如下进程相关信息
    * 文件, 目录, 连接(junction), 命名管道, 定时任务(scheduled task)
    * 进程
    * cpu使用情况
    * 注册表键值
    * 服务
    * tcp/udp连接
* 特性
    * 名称以`$77`开头的实体都会被隐藏
    * 配置放在`HKEY_LOCAL_MACHINE\SOFTWARE\$77config`键下. 当RegEdit跟着rootkit一起被植入系统后, 这个键会被隐藏. 
    * 安装器
        * `Installer.exe`: 安装r77服务. 系统所有进程都会被该服务注入. 
        * `Uninstall.exe`: 关闭服务, 解除所有注入. 
    * 子进程hook
        * 创建子进程后, 在其运行前, 会被注入. 
        * 因为在创建进程时, `NtResumeThread`函数总会被调用, 因此它适合hook. 
        * r77使用命名管道来处理子进程注入请求. 
        * 由于某些受保护进程(如`services.exe`)不能被注入, r77每100ms会检查一次新的进程, 看它有没有漏了子进程hook. 
    * 反射型dll注入: rootkit dll(`r77-x86.dll` 和 `r77-x64.dll`)可以从内存中被注入到进程里，无需保存在磁盘上. dll提供了一个导出函数，该函数被调用后会加载所有dll的所有区块，处理依赖以及重定位，然后执行DllMain. 
    * 无文件的持久化
        1. 启动两个定时任务(32位和64位). 定时任务使用powershell执行如下命令. 其加载注册表中指定的一个C#程序，然后运行(`Assembly.Load().EntryPoint.Invoke()`). 
            * `[Reflection.Assembly]::Load([Microsoft.Win32.Registry]::LocalMachine.OpenSubkey('SOFTWARE').GetValue('$77stager')).EntryPoint.Invoke($Null,$Null)`
        2. C#程序是一个stager, 其创建r77服务(使用进程冷注入(Process Hollowing)方法). 它们的父进程被设为`winlogon.exe`. 
    * hooking
        * 用`Detours`来hookntdll的一些函数. 
            * `NtQuerySystemInformation`
            * `NtResumeThread`
            * `NtQueryDirectoryFile`
            * `NtQueryDirectoryFileEx`
            * `NtEnumerateKey`
            * `NtEnumerateValueKey`
            * `EnumServiceGroupW`
            * `EnumServicesStatusExW`
            * `NtDeviceIoControlFile`

## dll注入
* 反射式dll注入
    * https://github.com/stephenfewer/ReflectiveDLLInjection